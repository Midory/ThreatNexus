package com.threatnexus.api.repository;

import com.threatnexus.api.model.Vulnerability;
import com.threatnexus.api.projection.VulnerabilityProjection;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;
import java.util.Optional;

public interface VulnerabilityRepository extends JpaRepository<Vulnerability, Long> {
    Optional<Vulnerability> findByCveId(String cveId);

    @Query(value = "SELECT " +
            "v.cve_id as cveId, " +
            "COALESCE((" +
            "  SELECT d->>'value' " +
            "  FROM jsonb_array_elements(v.data::jsonb->'cve'->'descriptions') d " +
            "  WHERE d->>'lang' = 'en' LIMIT 1" +
            "), 'No description') as description, " +
            "v.data::jsonb->'cve'->'metrics'->'cvssMetricV31'->0->'cvssData'->>'baseSeverity' as severity, " +
            "v.data::jsonb->'cve'->>'published' as published, " +
            "v.enriched_details::jsonb->'choices'->0->'message'->>'content' as enrichedDetails " +
            "FROM vulnerabilities v order by v.cve_id desc " +
            "LIMIT 100", nativeQuery = true)
    List<VulnerabilityProjection> findAllVulnerabilitiesProjected();

    @Query(value = "SELECT " +
            "v.cve_id as cveId, " +
            "COALESCE((" +
            "  SELECT d->>'value' " +
            "  FROM jsonb_array_elements(v.data::jsonb->'cve'->'descriptions') d " +
            "  WHERE d->>'lang' = 'en' LIMIT 1" +
            "), 'No description') as description, " +
            "v.data::jsonb->'cve'->'metrics'->'cvssMetricV31'->0->'cvssData'->>'baseSeverity' as severity, " +
            "v.data::jsonb->'cve'->>'published' as published, " +
            "v.enriched_details::jsonb->'choices'->0->'message'->>'content' as enrichedDetails " +
            "FROM vulnerabilities v " +
            "WHERE v.cve_id = :cveId", nativeQuery = true)
    Optional<VulnerabilityProjection> findVulnerabilityProjectionByCveId(@Param("cveId") String cveId);
}